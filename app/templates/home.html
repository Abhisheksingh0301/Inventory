{% extends "layout.html" %}
{% block title %}Sales Management{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
    <h2 class="text-3xl font-bold text-gray-800 mb-6">ðŸ“¦ Record a Sale</h2>
    <pre>Product Names: {{ product_names|default([])|tojson }}</pre>



    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-4">
        {% for category, message in messages %}
        <div class="p-4 rounded text-white
                     {% if category == 'success' %} bg-green-500
                     {% elif category == 'danger' %} bg-red-500
                     {% elif category == 'warning' %} bg-yellow-500
                     {% else %} bg-gray-500 {% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    {% if not product_names %}
    <p class="text-red-500 mb-4">No products available. Please <a href="{{ url_for('main.products') }}"
            class="underline">add products</a> first.</p>
    {% endif %}

    <form method="POST" action="{{ url_for('main.sales') }}" class="space-y-6 bg-white p-6 rounded-lg shadow-md">
        <!-- Item -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Item Name</label>
            <!-- âœ… Use the unique product names passed as 'product_names' -->
            <select id="item" required class="w-full border rounded px-3 py-2">
                <option value="">Select Item</option>
                {% for name in product_names %}
                <option value="{{ name }}">{{ name }}</option>
                {% endfor %}
            </select>

        </div>

        <!-- Brand -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Brand</label>
            <select id="brand" required class="w-full border rounded px-3 py-2"></select>
        </div>

        <!-- Size -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Size</label>
            <select id="size" name="product_id" required class="w-full border rounded px-3 py-2"></select>
        </div>

        <!-- Customer -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Customer Name</label>
            <input type="text" name="customer_name" required placeholder="Enter customer name"
                class="w-full border rounded px-3 py-2" />
        </div>

        <!-- Quantity -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
            <input type="number" name="quantity" min="1" required class="w-full border rounded px-3 py-2">
        </div>

        <!-- Price & Discount -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Sale Price (per unit)</label>
                <input type="number" step="0.01" name="sale_price" required class="w-full border rounded px-3 py-2">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Discount</label>
                <input type="number" step="0.01" name="discount_amount" value="0"
                    class="w-full border rounded px-3 py-2">
            </div>
        </div>

        <!-- Invoice Info -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Invoice Number</label>
                <input type="text" name="invoice_number" required class="w-full border rounded px-3 py-2">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Invoice Date</label>
                <input type="date" name="invoice_date" required class="w-full border rounded px-3 py-2">
            </div>
        </div>

        <!-- Sale Info -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Sale Date</label>
                <input type="date" name="sale_date" required class="w-full border rounded px-3 py-2">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Place of Supply</label>
                <input type="text" name="place_of_supply" placeholder="e.g. MH" required
                    class="w-full border rounded px-3 py-2">
            </div>
        </div>

        <!-- Tax & Sale Type -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tax Status</label>
                <select name="tax_status" class="w-full border rounded px-3 py-2">
                    <option value="taxable">Taxable</option>
                    <option value="exempt">Exempt</option>
                    <option value="zero-rated">Zero Rated</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Sale Type</label>
                <select name="sale_type" class="w-full border rounded px-3 py-2">
                    <option value="cash">Cash</option>
                    <option value="credit">Credit</option>
                    <option value="online">Online</option>
                </select>
            </div>
        </div>

        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded">
            Submit Sale
        </button>
    </form>
</div>

<script>
    (function () {
        let products = {{ products | default ([]) | tojson | safe
    }};
    const itemDropdown = document.getElementById('item');
    const brandDropdown = document.getElementById('brand');
    const sizeDropdown = document.getElementById('size');

    // When item changes, fetch brands and sizes
    itemDropdown.addEventListener('change', function () {
        const selectedItem = this.value;
        brandDropdown.innerHTML = '<option value="">Select Brand</option>';
        sizeDropdown.innerHTML = '<option value="">Select Size</option>';
        if (!selectedItem) return;

        fetch("{{ url_for('main.get_brands_sizes') }}", {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ item_name: selectedItem })
        })
            .then(res => res.json())
            .then(data => {
                for (let brand in data) {
                    const option = document.createElement('option');
                    option.value = brand;
                    option.textContent = brand;
                    brandDropdown.appendChild(option);
                }
            });
    });

    // When brand changes, populate sizes
    brandDropdown.addEventListener('change', function () {
        const selectedItem = itemDropdown.value;
        const selectedBrand = this.value;
        sizeDropdown.innerHTML = '<option value="">Select Size</option>';

        if (!selectedItem || !selectedBrand) return;

        // Filter products for selected item and brand to get sizes
        const sizes = products
            .filter(p => p.name === selectedItem && p.brand === selectedBrand)
            .map(p => p.item_size)
            .filter((v, i, a) => a.indexOf(v) === i); // unique sizes

        sizes.forEach(size => {
            // Find product id for this combination
            const product = products.find(p =>
                p.name === selectedItem && p.brand === selectedBrand && p.item_size === size
            );
            if (product) {
                const opt = document.createElement('option');
                opt.value = product.id;
                opt.textContent = size || "N/A";
                sizeDropdown.appendChild(opt);
            }
        });
    });
}) ();
</script>

{% endblock %}